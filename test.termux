su

mkdir -p /sdcard/cfl_watch
cat > /sdcard/cfl_watch/snap.sh <<'SH'
#!/system/bin/sh
# Usage: su -c sh /sdcard/cfl_watch/snap.sh <LABEL>
LABEL="$1"
[ -z "$LABEL" ] && echo "Usage: snap.sh <LABEL>" && exit 1

BASE="/sdcard/cfl_watch/$LABEL"
TS="$(date +%Y%m%d_%H%M%S)"
OUT="$BASE/run_$TS"
mkdir -p "$OUT" || exit 1

# 1) Dump UI + screenshot
uiautomator dump "$OUT/ui.xml" >/dev/null 2>&1 || exit 2
screencap -p "$OUT/screen.png" >/dev/null 2>&1 || true

# 2) Extract visible texts (text + content-desc), normalize, sort
cat "$OUT/ui.xml" \
 | grep -oE 'text="[^"]*"|content-desc="[^"]*"' \
 | sed -E 's/^(text|content-desc)="(.*)"$/\2/g' \
 | sed -E 's/[[:space:]]+/ /g; s/^ //; s/ $//' \
 | grep -vE '^$' \
 | sed -E 's/\b[0-9]{1,2}:[0-9]{2}\b/<TIME>/g; s/\b[0-9]+\b/<NUM>/g' \
 | sort -u > "$OUT/texts.txt"

# 3) Diff with previous run
PREV="$(ls -1 "$BASE" 2>/dev/null | grep '^run_' | sort | tail -n 2 | head -n 1)"
if [ -n "$PREV" ] && [ -f "$BASE/$PREV/texts.txt" ]; then
  diff -u "$BASE/$PREV/texts.txt" "$OUT/texts.txt" > "$OUT/diff.txt" || true
fi

echo "OK -> $OUT"
SH

chmod +x /sdcard/cfl_watch/snap.sh
exit
