=== FETCH https://raw.githubusercontent.com/valentinritz-coder/termux-scripts/main/console.sh ===
=== EXEC /sdcard/cfl_watch/tmp/console.sh ===
+ ADB_TCP_PORT=37099
+ bash /sdcard/cfl_watch/runner.sh
[*] Start ADB local on 127.0.0.1:37099
[*] Activation ADB TCP sur 127.0.0.1:37099 (root)
[*] Redémarrage adbd
[*] Attente adbd=running
[*] adb connect (retry) -> 127.0.0.1:37099
[*] connected to 127.0.0.1:37099
[*] getprop:
37099
running

[*] adb devices -l:
List of devices attached
127.0.0.1:37099        device product:blueline model:Pixel_3 device:blueline transport_id:1


[*] Pour éviter 'more than one device':
    adb -s 127.0.0.1:37099 shell <commande>
    ou dans TON terminal: export ANDROID_SERIAL=127.0.0.1:37099

=== RUN: SNAP_ON=0 DELAY_LAUNCH=1.0 DELAY_TAP=0.25 DELAY_TYPE=0.45 DELAY_PICK=0.35 DELAY_SEARCH=1.0 bash /sdcard/cfl_watch/scenario_trip_lux_arlon.sh ===
[*] scenario_trip.sh path: /sdcard/cfl_watch/scenario_trip.sh
[*] scenario_trip.sh sha1: b42544b1cae75af038698000b7aeb60ef9337d38
[*] scenario_trip.sh head:
#!/data/data/com.termux/files/usr/bin/bash
set -euo pipefail

BASE="/sdcard/cfl_watch"
HOST="${ADB_HOST:-127.0.0.1}"
PORT="${ADB_TCP_PORT:-37099}"
SER="${ANDROID_SERIAL:-$HOST:$PORT}"
export ANDROID_SERIAL="$SER"

START_TEXT="${1:-Luxembourg}"
TARGET_TEXT="${2:-Arlon}"
DELAY="${DELAY:-1.2}"

mkdir -p "$BASE"/{logs,tmp,runs}

TS="$(date +%Y-%m-%d_%H-%M-%S)"
LOG="$BASE/logs/scenario_trip_$TS.log"
exec > >(tee -a "$LOG") 2>&1

echo "=== scenario_trip START $TS ==="
echo "[*] SER=$SER PORT=$PORT START=$START_TEXT TARGET=$TARGET_TEXT"
echo "[*] LOG=$LOG"

. "$BASE/snap.sh"
declare -F snap_init >/dev/null 2>&1 || { echo "[!] snap_init introuvable"; exit 2; }
declare -F snap      >/dev/null 2>&1 || { echo "[!] snap introuvable"; exit 2; }

inject() { adb -s "$SER" shell "$@"; }
sleep_s() { sleep "${1:-$DELAY}"; }
tap() { echo "[*] tap $1 $2"; inject input tap "$1" "$2" >/dev/null 2>&1 || true; }
key() { echo "[*] key $1"; inject input keyevent "$1" >/dev/null 2>&1 || true; }

type_text() {
  local t="$1"
  t="${t//\'/}"
  t="${t// /%s}"
  echo "[*] type: $t"
  inject input text "$t" >/dev/null 2>&1 || true
}

snap_init "trip_${START_TEXT}_to_${TARGET_TEXT}"

echo "[*] Launch CFL"
inject monkey -p de.hafas.android.cfl -c android.intent.category.LAUNCHER 1 >/dev/null 2>&1 || true
sleep 2

echo "[*] Focus:"
inject dumpsys window windows 2>/dev/null | grep -E "mCurrentFocus|mFocusedApp" || true
snap "00_first_screen"

echo "[*] Destination"
tap 518 561
sleep_s 0.6
snap "01_after_tap_dest"
type_text "$TARGET_TEXT"
sleep_s 0.3
snap "02_after_type_dest"
key 66
sleep_s 1.0
snap "03_after_enter_dest"

echo "[*] Start"
tap 518 407
sleep_s 0.6
snap "04_after_tap_start"
type_text "$START_TEXT"
sleep_s 0.3
snap "05_after_type_start"
key 66
sleep_s 1.0
snap "06_after_enter_start"

echo "[*] Search"
tap 970 561
sleep_s 2.0
snap "07_after_search"

if grep -qEi "Results|Résultats|Itinéraires|Trajet" "$SNAP_DIR/"*"_07_after_search.xml" 2>/dev/null; then
  echo "[+] OK (keyword detected)"
  exit 0
----
[*] SNAP_DIR=/sdcard/cfl_watch/runs/2026-01-02_11-19-31_trip_Luxembourg_to_Arlon
[*] Launch CFL
[*] Open start field
[!] Unable to find selector for start field with criteria: content-desc=Select start
[*] Tap start field (history) at 518,407
[*] Type start: LUXEMBOURG
[*] Choose start suggestion
[*] Tap start suggestion at 540,313
[*] Open destination field
[!] Unable to find selector for destination field with criteria: resource-id=de.hafas.android.cfl:id/input_target
[*] Tap destination field (fallback) at 534,473
[*] Type destination: ARLON
[*] Choose destination suggestion
[*] Tap destination suggestion at 540,313
[*] Launch search
[*] Tap search button (id default) at 540,720
[*] Evaluate result heuristics
[!] No after_search snapshot found; treating as failure
[*] Run FAILED (rc=1) -> génération viewers...
[*] SNAP_DIR=/sdcard/cfl_watch/runs/2026-01-02_11-19-31_trip_Luxembourg_to_Arlon
[*] OUT=/sdcard/cfl_watch/runs/2026-01-02_11-19-31_trip_Luxembourg_to_Arlon/viewers
[+] Viewers générés: 0
[+] Index: /sdcard/cfl_watch/runs/2026-01-02_11-19-31_trip_Luxembourg_to_Arlon/viewers/index.html
[*] Pour ouvrir: cd '/sdcard/cfl_watch/runs/2026-01-02_11-19-31_trip_Luxembourg_to_Arlon/viewers' && python -m http.server 8000
[*] Viewers OK: /sdcard/cfl_watch/runs/2026-01-02_11-19-31_trip_Luxembourg_to_Arlon/viewers/index.html
=== RC=1 ===
[*] Force-stop CFL
[*] Done. LOG=/sdcard/cfl_watch/logs/runner_2026-01-02_11-19-28.log
=== DONE ===
